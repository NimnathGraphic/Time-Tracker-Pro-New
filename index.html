<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TimeTrack Pro - Employee Time Management System (AU)</title>
    <!-- External Libraries -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css?family=Poppins:400,500,600,700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <!-- Custom Stylesheet -->
    <link rel="stylesheet" href="style.css">

    <!-- Firebase SDKs (v9 Modular) -->
    <!-- NOTE: config.js contains the Firebase initialization code and exports the necessary functions. -->
    <script type="module" src="config.js"></script>
</head>
<body>

    <!-- 1. Login Page -->
    <div id="loginPage" class="login-page">
        <div class="login-wrapper">
            <h1 class="login-title" id="loginCompanyName">TimeTrack Pro</h1>
            <form id="loginForm" onsubmit="handleLogin(event)">
                <div id="loginAlert" class="alert alert-danger" style="display: none;"></div>
                <div class="field">
                    <input type="text" id="loginUsername" required>
                    <label>Username</label>
                </div>
                <div class="field password-field">
                    <input type="password" id="loginPassword" required>
                    <label>Password</label>
                    <i class="fas fa-eye password-toggle" onclick="togglePasswordVisibility('loginPassword')"></i>
                </div>
                <input type="submit" value="LOGIN">
            </form>
        </div>
        <div id="companyNameWatermark" class="watermark">Â© TimeTrack Pro</div>
    </div>

    <!-- 2. Main Application -->
    <div id="mainApp" style="display: none;">
        <header>
            <div class="container header-content">
                <div class="logo">
                    <i class="fas fa-clock"></i>
                    <span id="headerCompanyName">TimeTrack Pro</span>
                </div>
                <div class="user-info" onclick="toggleDropdown()">
                    <div class="user-avatar" id="userAvatar">
                        <i class="fas fa-user"></i>
                    </div>
                    <div class="dropdown-menu" id="userDropdown">
                        <a href="#" id="dropdownUserName"></a>
                        <a href="#" id="dropdownUserRole"></a>
                        <a href="#" onclick="logout()">
                            <i class="fas fa-sign-out-alt"></i> Logout
                        </a>
                    </div>
                </div>
            </div>
        </header>

        <nav>
            <div class="container">
                <ul class="nav-tabs" id="navTabs">
                    <li data-tab="dashboard" class="active"><i class="fas fa-tachometer-alt"></i> Dashboard</li>
                    <li data-tab="timeEntry"><i class="fas fa-clock"></i> Time Entry</li>
                    <li data-tab="employees"><i class="fas fa-users"></i> Employees</li>
                    <li data-tab="reports"><i class="fas fa-chart-line"></i> Reports</li>
                    <li data-tab="shops" id="shopsTab" style="display: none;"><i class="fas fa-store"></i> Shops</li>
                    <li data-tab="settings"><i class="fas fa-cog"></i> Settings</li>
                </ul>
            </div>
        </nav>

        <main class="container">
            <div id="appAlert" class="alert" style="display: none;"></div>

            <!-- Dashboard Tab -->
            <div id="dashboardTab" class="tab-content active">
                <div id="dashboardContent" class="dashboard">
                    <!-- Time Clock Card (For standard managers/staff) -->
                    <div id="timeClockCard" class="card">
                        <div class="card-header">
                            <h2>Time Clock</h2>
                            <button class="btn btn-secondary btn-small" onclick="openManualEntryModal()">Manual Entry</button>
                        </div>
                        <div class="live-clock" id="liveClock">00:00:00</div>
                        <div class="current-date" id="currentDate"></div>
                        <div class="form-group">
                            <label for="employeeSelect">Select Employee</label>
                            <select id="employeeSelect" class="form-control"></select>
                        </div>
                        <div class="action-buttons">
                            <button id="clockInBtn" class="btn btn-success" onclick="handleClockAction('in')"><i class="fas fa-sign-in-alt"></i> Clock In</button>
                            <button id="breakStartBtn" class="btn btn-warning" onclick="handleClockAction('breakStart')" style="display: none;"><i class="fas fa-coffee"></i> Break Start</button>
                            <button id="breakEndBtn" class="btn btn-info" onclick="handleClockAction('breakEnd')" style="display: none;"><i class="fas fa-mug-hot"></i> Break End</button>
                            <button id="clockOutBtn" class="btn btn-danger" onclick="handleClockAction('out')" style="display: none;"><i class="fas fa-sign-out-alt"></i> Clock Out</button>
                        </div>
                    </div>

                    <!-- Full Access Dashboard Content (Owner/Full Access Manager) -->
                    <div id="fullAccessDashboard" class="full-access-dashboard" style="display: none;">
                        <div class="card">
                            <div class="card-header">
                                <h2>Shop Performance Overview (Current Week)</h2>
                            </div>
                            <div id="shopPerformanceStats" class="summary-stats">
                                <!-- Stats will be populated here -->
                            </div>
                        </div>
                        <div class="card">
                            <div class="card-header">
                                <h2>Recent Time Entries</h2>
                            </div>
                            <div class="table-responsive">
                                <table id="recentEntriesTable">
                                    <thead>
                                        <tr>
                                            <th>Employee</th>
                                            <th>Shop</th>
                                            <th>Time</th>
                                            <th>Action</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- Recent entries will be populated here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Time Entry Tab (Hidden as it's merged with Dashboard) -->
            <div id="timeEntryTab" class="tab-content">
                <!-- Content merged into Dashboard -->
            </div>

            <!-- Employees Tab -->
            <div id="employeesTab" class="tab-content">
                <div class="card">
                    <div class="card-header">
                        <h2>Employee Management</h2>
                        <button class="btn btn-primary" onclick="openAddEmployeeModal()"><i class="fas fa-user-plus"></i> Add New Employee</button>
                    </div>
                    <div class="table-responsive">
                        <table id="employeeTable">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Name</th>
                                    <th>Username</th>
                                    <th>Role</th>
                                    <th>Shop</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Employee data will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Reports Tab -->
            <div id="reportsTab" class="tab-content">
                <div class="card">
                    <div class="card-header">
                        <h2>Generate Reports</h2>
                    </div>
                    <div class="form-group">
                        <label for="reportType">Report Type</label>
                        <select id="reportType" class="form-control">
                            <option value="daily">Daily</option>
                            <option value="weekly">Weekly</option>
                            <option value="monthly">Monthly</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="reportShopSelect">Filter by Shop (Optional)</label>
                        <select id="reportShopSelect" class="form-control"></select>
                    </div>
                    <div class="form-group">
                        <label for="reportDate">Date/Week/Month Selection</label>
                        <input type="date" id="reportDate" class="form-control">
                    </div>
                    <div class="action-buttons">
                        <button class="btn btn-primary" onclick="generateReport()"><i class="fas fa-search"></i> Generate</button>
                        <button class="btn btn-info" onclick="exportReport('pdf')"><i class="fas fa-file-pdf"></i> Export PDF</button>
                        <button class="btn btn-success" onclick="exportReport('excel')"><i class="fas fa-file-excel"></i> Export Excel</button>
                    </div>
                </div>

                <div class="card" style="margin-top: 25px;">
                    <div class="card-header">
                        <h2>Report Preview</h2>
                    </div>
                    <div id="reportSummaryStats" class="summary-stats">
                        <!-- Summary stats will be populated here -->
                    </div>
                    <div class="table-responsive">
                        <table id="reportTable">
                            <thead>
                                <tr>
                                    <th>Employee</th>
                                    <th>Shop</th>
                                    <th>Date</th>
                                    <th>Clock In</th>
                                    <th>Clock Out</th>
                                    <th>Break (hrs)</th>
                                    <th>Work (hrs)</th>
                                    <th>Weekend (hrs)</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Report data will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Shops Tab (Owner Only) -->
            <div id="shopsTabContent" class="tab-content">
                <div class="card">
                    <div class="card-header">
                        <h2>Shop Management</h2>
                        <button class="btn btn-primary" onclick="openAddShopModal()"><i class="fas fa-store"></i> Add New Shop</button>
                    </div>
                    <div class="table-responsive">
                        <table id="shopsTable">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Name</th>
                                    <th>Manager</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Shop data will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="card" style="margin-top: 25px;">
                    <div class="card-header">
                        <h2>Manager Access Control</h2>
                    </div>
                    <div id="managerList">
                        <!-- Manager list will be populated here -->
                    </div>
                </div>
            </div>

            <!-- Settings Tab -->
            <div id="settingsTab" class="tab-content">
                <div class="settings-grid">
                    <div class="settings-row">
                        <!-- Owner Settings Card -->
                        <div id="ownerSettingsCard" class="card" style="display: none;">
                            <div class="card-header">
                                <h2>Owner & Company Settings</h2>
                            </div>
                            <form id="ownerSettingsForm" onsubmit="saveOwnerSettings(event)">
                                <div class="owner-settings-form">
                                    <div class="photo-upload-section">
                                        <img id="profilePhotoPreview" class="profile-photo-preview" src="https://via.placeholder.com/100?text=Owner" alt="Profile Photo" onclick="document.getElementById('photoFile').click()">
                                        <input type="file" id="photoFile" accept="image/*" style="display: none;" onchange="handlePhotoUpload(event, 'owner')">
                                        <p class="text-muted">Click to upload photo</p>
                                    </div>
                                    <div class="input-section">
                                        <div class="form-group">
                                            <label for="ownerCompanyName">Company Name</label>
                                            <input type="text" id="ownerCompanyName" required>
                                        </div>
                                        <div class="form-group">
                                            <label for="ownerUsername">Owner Username</label>
                                            <input type="text" id="ownerUsername" required>
                                        </div>
                                        <div class="form-group" style="grid-column: 1 / -1;">
                                            <label for="ownerProfilePhotoBase64">Photo URL / Base64 (Optional)</label>
                                            <input type="text" id="ownerProfilePhotoBase64" placeholder="Paste image URL or Base64 string">
                                        </div>
                                        <div class="action-buttons" style="grid-column: 1 / -1;">
                                            <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> Save Settings</button>
                                        </div>
                                    </div>
                                </div>
                            </form>
                        </div>

                        <!-- Change Password Card -->
                        <div id="changePasswordCard" class="card">
                            <div class="card-header">
                                <h2>Change Password</h2>
                            </div>
                            <form id="changePasswordForm" onsubmit="changePassword(event)">
                                <div class="form-group password-field">
                                    <label for="currentPassword">Current Password</label>
                                    <input type="password" id="currentPassword" required>
                                    <i class="fas fa-eye password-toggle" onclick="togglePasswordVisibility('currentPassword')"></i>
                                </div>
                                <div class="form-group password-field">
                                    <label for="newPassword">New Password</label>
                                    <input type="password" id="newPassword" required>
                                    <i class="fas fa-eye password-toggle" onclick="togglePasswordVisibility('newPassword')"></i>
                                </div>
                                <div class="form-group password-field">
                                    <label for="confirmNewPassword">Confirm New Password</label>
                                    <input type="password" id="confirmNewPassword" required>
                                    <i class="fas fa-eye password-toggle" onclick="togglePasswordVisibility('confirmNewPassword')"></i>
                                </div>
                                <div class="action-buttons">
                                    <button type="submit" class="btn btn-primary"><i class="fas fa-key"></i> Change Password</button>
                                </div>
                            </form>
                        </div>
                    </div>

                    <!-- Manager Settings Card -->
                    <div id="managerSettingsCard" class="card" style="display: none;">
                        <div class="card-header">
                            <h2>Manager Profile Settings</h2>
                        </div>
                        <form id="managerSettingsForm" onsubmit="saveManagerSettings(event)">
                            <div class="owner-settings-form">
                                <div class="photo-upload-section">
                                    <img id="managerProfilePhotoPreview" class="profile-photo-preview" src="https://via.placeholder.com/100?text=Manager" alt="Profile Photo" onclick="document.getElementById('managerPhotoFile').click()">
                                    <input type="file" id="managerPhotoFile" accept="image/*" style="display: none;" onchange="handlePhotoUpload(event, 'manager')">
                                    <p class="text-muted">Click to upload photo</p>
                                </div>
                                <div class="input-section">
                                    <div class="form-group">
                                        <label for="managerName">Full Name</label>
                                        <input type="text" id="managerName" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="managerUsername">Username</label>
                                        <input type="text" id="managerUsername" required>
                                    </div>
                                    <div class="form-group" style="grid-column: 1 / -1;">
                                        <label for="managerProfilePhotoBase64">Photo URL / Base64 (Optional)</label>
                                        <input type="text" id="managerProfilePhotoBase64" placeholder="Paste image URL or Base64 string">
                                    </div>
                                    <div class="action-buttons" style="grid-column: 1 / -1;">
                                        <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> Save Profile</button>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modals -->

    <!-- Add/Edit Employee Modal -->
    <div id="addEmployeeModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="employeeModalTitle">Add New Employee</h2>
                <button class="close-btn" onclick="closeModal('addEmployeeModal')">&times;</button>
            </div>
            <form id="employeeForm" onsubmit="saveEmployee(event)">
                <input type="hidden" id="employeeId">
                <div class="form-group">
                    <label for="employeeName">Full Name</label>
                    <input type="text" id="employeeName" required>
                </div>
                <div class="form-group" id="employeeRoleGroup">
                    <label for="employeeRole">Role</label>
                    <select id="employeeRole" class="form-control" onchange="toggleManagerFields()">
                        <option value="Staff">Staff</option>
                        <option value="Manager">Manager</option>
                    </select>
                </div>
                <div id="managerFields" style="display: none;">
                    <div class="form-group">
                        <label for="employeeUsername">Username</label>
                        <input type="text" id="employeeUsername" required>
                    </div>
                    <div class="form-group password-field">
                        <label for="employeePassword">Initial Password</label>
                        <input type="password" id="employeePassword" required>
                        <i class="fas fa-eye password-toggle" onclick="togglePasswordVisibility('employeePassword')"></i>
                    </div>
                    <div class="form-group" id="fullAccessGroup">
                        <input type="checkbox" id="employeeFullAccess">
                        <label for="employeeFullAccess" style="display: inline; margin-left: 10px;">Grant Full System Access (Owner Only)</label>
                    </div>
                </div>
                <div class="form-group" id="employeeShopGroup">
                    <label for="employeeShop">Shop Assignment</label>
                    <select id="employeeShop" class="form-control" required></select>
                </div>
                <div class="action-buttons">
                    <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> Save Employee</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Manual Time Entry Modal -->
    <div id="manualEntryModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Manual Time Entry</h2>
                <button class="close-btn" onclick="closeModal('manualEntryModal')">&times;</button>
            </div>
            <form id="manualEntryForm" onsubmit="submitManualEntry(event)">
                <div class="form-group">
                    <label for="manualEmployeeSelect">Select Employee</label>
                    <select id="manualEmployeeSelect" class="form-control" required></select>
                </div>
                <div class="form-group">
                    <label for="manualDate">Date</label>
                    <div style="display: flex; gap: 10px;">
                        <input type="date" id="manualDate" class="form-control" required>
                        <button type="button" class="btn btn-secondary btn-small" onclick="setManualDateToToday()">Today</button>
                    </div>
                </div>
                <div class="form-group">
                    <label for="manualTimeIn">Clock In Time</label>
                    <input type="time" id="manualTimeIn" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="manualTimeOut">Clock Out Time</label>
                    <input type="time" id="manualTimeOut" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="manualBreakDuration">Break Duration (Minutes)</label>
                    <input type="number" id="manualBreakDuration" class="form-control" value="30" min="0" required>
                </div>
                <div class="action-buttons">
                    <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> Submit Entry</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add/Edit Shop Modal -->
    <div id="addShopModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="shopModalTitle">Add New Shop</h2>
                <button class="close-btn" onclick="closeModal('addShopModal')">&times;</button>
            </div>
            <form id="shopForm" onsubmit="saveShop(event)">
                <input type="hidden" id="shopId">
                <div class="form-group">
                    <label for="shopName">Shop Name</label>
                    <input type="text" id="shopName" required>
                </div>
                <div class="form-group">
                    <label for="shopManager">Assign Manager (Optional)</label>
                    <select id="shopManager" class="form-control"></select>
                </div>
                <div class="action-buttons">
                    <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> Save Shop</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Custom Script -->
    <script type="module" src="script.js"></script>
</body>
</html>
